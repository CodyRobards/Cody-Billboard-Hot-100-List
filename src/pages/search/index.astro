---
import SiteLayout from "../../layouts/SiteLayout.astro";
import {
  filterNumberOneSearchRecords,
  loadNumberOneSearchIndex,
} from "../../lib/number-one-search-index";
import numberOneSearchScriptHref from "../../scripts/number-one-search.ts?url";

const results = await loadNumberOneSearchIndex();
const indexJson = JSON.stringify(results).replace(/</g, "\\u003c");
const initialQuery = Astro.url.searchParams.get("q")?.trim() ?? "";
const initialResults = initialQuery ? filterNumberOneSearchRecords(results, initialQuery) : [];
const initialCountMessage = initialQuery
  ? initialResults.length
    ? `${initialResults.length} matching #1 hit${initialResults.length > 1 ? "s" : ""}`
    : "No #1 hits match your search."
  : "Loading #1 hits‚Ä¶";
const showInitialEmptyState = Boolean(initialQuery && initialResults.length === 0);
---

<SiteLayout
  pageTitle="Search #1 hits"
  description="Instantly filter Billboard Hot 100 number-one songs across the full archive."
>
  <section
    class="section"
    aria-labelledby="number-one-search-heading"
    data-number-one-search-index-json={indexJson}
  >
    <header class="section__header">
      <h1 class="section__title" id="number-one-search-heading">Search #1 hits</h1>
      <p class="section__lead">
        Type a song title, artist, or year to filter every Billboard Hot 100 number-one in the
        archive. Results update instantly and preserve the Spotify previews.
      </p>
    </header>

    <form
      class="number-one-search__form"
      role="search"
      aria-label="Search number-one hits"
      novalidate
      data-number-one-search-form
    >
      <label class="number-one-search__label" for="number-one-search-input">
        Search by song, artist, or year
      </label>
      <div class="number-one-search__field">
        <input
          id="number-one-search-input"
          class="number-one-search__input"
          type="search"
          name="q"
          inputmode="search"
          autocomplete="off"
          placeholder="Try Whitney Houston 1986"
          data-number-one-search-input
          aria-describedby="number-one-search-count"
          value={initialQuery}
        />
        <div class="number-one-search__controls">
          <button
            type="button"
            class="number-one-search__button number-one-search__button--clear"
            aria-label="Clear search input"
            data-number-one-search-clear
          >
            <span aria-hidden="true">üû™</span>
          </button>
        </div>
      </div>
    </form>

    <p
      class="number-one-search__count"
      id="number-one-search-count"
      data-number-one-search-count
      aria-live="polite"
    >
      {initialCountMessage}
    </p>
    <p
      class="number-one-search__empty"
      data-number-one-search-empty
      aria-live="polite"
      hidden={!showInitialEmptyState}
    >
      No #1 hits match your search. Try another song title, artist, or year.
    </p>

    <ol class="number-one-search-results" data-number-one-search-list>
      {
        initialResults.map((entry) => {
          const embedId = `search-${entry.id}`;
          const yearsLabel = entry.appearances.map((appearance) => appearance.year).join(", ");
          return (
            <li class="number-one-search-results__item" data-entry-id={entry.id}>
              <div class="number-one-search-results__content">
                <div class="number-one-search-results__header">
                  <span class="number-one-search-results__year">{yearsLabel}</span>
                  <h3 class="number-one-search-results__title">‚Äú{entry.title}‚Äù</h3>
                  <p class="number-one-search-results__artist">
                    {"by "}
                    <a
                      class="number-one-search-results__artist-link"
                      href={`/search/?q=${encodeURIComponent(entry.artist)}`}
                    >
                      {entry.artist}
                    </a>
                  </p>
                </div>
                {entry.notes.length ? (
                  <ul class="number-one-search-results__notes">
                    {entry.notes.map((note) => (
                      <li>{note}</li>
                    ))}
                  </ul>
                ) : null}
                <div class="number-one-search-results__actions">
                  {entry.appearances.map((appearance) => (
                    <a
                      class="number-one-search-results__link number-one-search-results__link--pill"
                      href={`/years/${appearance.slug}/`}
                    >
                      View {appearance.year} Recap
                    </a>
                  ))}
                  {entry.spotifyTrackId ? (
                    <div class="number-one-search-results__spotify">
                      <button
                        type="button"
                        class="overall-ranking-list__spotify-toggle"
                        data-track-id={entry.spotifyTrackId}
                        aria-controls={embedId}
                        aria-expanded="false"
                      >
                        Play on Spotify
                      </button>
                      <div id={embedId} class="overall-ranking-list__spotify" hidden />
                    </div>
                  ) : null}
                </div>
              </div>
            </li>
          );
        })
      }
    </ol>

    <script type="module" defer src={numberOneSearchScriptHref}></script>
  </section>
</SiteLayout>

<style>
  @import "../../styles/overall-ranking-list.css";

  .number-one-search__form {
    display: grid;
    gap: 0.5rem;
    margin-top: 1rem;
    max-width: 32rem;
  }

  .number-one-search__label {
    font-weight: 600;
  }

  .number-one-search__field {
    position: relative;
    display: flex;
    align-items: center;
  }

  .number-one-search__input {
    padding: 0.6rem 5.4rem 0.6rem 0.95rem;
    border: 1px solid rgba(246, 238, 227, 0.18);
    border-radius: 999px;
    font: inherit;
    color: inherit;
    background-color: rgba(28, 19, 14, 0.65);
    box-shadow: inset 0 1px 1.5px rgba(0, 0, 0, 0.35);
    width: 100%;
  }

  .number-one-search__input:focus-visible {
    outline: 3px solid rgba(211, 151, 101, 0.45);
    outline-offset: 2px;
    background-color: rgba(28, 19, 14, 0.78);
  }

  .number-one-search__controls {
    position: absolute;
    top: 50%;
    right: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    transform: translateY(-50%);
  }

  .number-one-search__button {
    inline-size: 2.5rem;
    block-size: 2.5rem;
    border-radius: 999px;
    border: 1px solid rgba(246, 238, 227, 0.24);
    background-color: rgba(246, 238, 227, 0.08);
    color: rgba(238, 215, 192, 0.78);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    font: inherit;
    line-height: 1;
    cursor: pointer;
    transition:
      background-color var(--transition-speed) ease,
      color var(--transition-speed) ease,
      border-color var(--transition-speed) ease,
      box-shadow var(--transition-speed) ease;
  }

  .number-one-search__button:hover,
  .number-one-search__button:focus-visible {
    background-color: rgba(246, 238, 227, 0.18);
    color: var(--color-ink);
    border-color: rgba(246, 238, 227, 0.48);
  }

  .number-one-search__button:focus-visible {
    outline: 3px solid rgba(211, 151, 101, 0.45);
    outline-offset: 2px;
    box-shadow: 0 0 0 3px rgba(18, 12, 8, 0.45);
  }

  .number-one-search__button--clear span {
    font-size: 1.45rem;
    line-height: 1;
  }

  .number-one-search__count,
  .number-one-search__empty {
    margin-top: 0.75rem;
    color: var(--color-muted);
  }

  .number-one-search__empty {
    font-style: italic;
  }

  .number-one-search-results {
    margin: 1.5rem 0 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 1.35rem;
  }

  .number-one-search-results__item {
    border: 1px solid rgba(231, 201, 175, 0.22);
    border-radius: 1rem;
    background: rgba(28, 19, 14, 0.85);
    box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.32);
    padding: clamp(1.1rem, 2vw, 1.5rem);
  }

  .number-one-search-results__header {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .number-one-search-results__year {
    font-weight: 700;
    color: var(--color-accent);
    font-size: clamp(1.05rem, 0.2vw + 1.02rem, 1.2rem);
  }

  .number-one-search-results__title {
    margin: 0;
    font-size: clamp(1.25rem, 0.35vw + 1.2rem, 1.55rem);
    font-weight: 600;
    color: var(--color-ink);
  }

  .number-one-search-results__artist {
    margin: 0;
    color: var(--color-muted);
    font-size: clamp(1.05rem, 0.18vw + 1rem, 1.2rem);
  }

  .number-one-search-results__artist-link {
    color: inherit;
    text-decoration: none;
  }

  .number-one-search-results__artist-link:hover,
  .number-one-search-results__artist-link:focus-visible {
    text-decoration: underline;
  }

  .number-one-search-results__notes {
    margin: clamp(0.75rem, 1vw, 1.1rem) 0 0;
    padding: 0 0 0 1.25rem;
    display: grid;
    gap: 0.5rem;
    color: var(--color-muted);
    font-size: clamp(0.95rem, 0.15vw + 0.92rem, 1.05rem);
  }

  .number-one-search-results__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
    margin-top: clamp(0.85rem, 1.2vw, 1.2rem);
    align-items: center;
  }

  .number-one-search-results__link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 auto;
    white-space: nowrap;
    text-decoration: none;
  }

  .number-one-search-results__link--pill {
    padding: 0.5rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-paper);
    background: var(--color-accent);
    box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.35);
    transition:
      transform var(--transition-speed) ease,
      box-shadow var(--transition-speed) ease,
      background-color var(--transition-speed) ease;
  }

  .number-one-search-results__link--pill {
    text-decoration: none;
  }

  .number-one-search-results__link--pill:hover,
  .number-one-search-results__link--pill:focus-visible {
    transform: translateY(-0.15rem);
    box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.45);
    background-color: #e0a871;
  }

  .number-one-search-results__spotify {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    min-width: 16rem;
  }

  @media (max-width: 40rem) {
    .number-one-search-results__item {
      padding: 1rem;
    }

    .number-one-search-results__spotify {
      min-width: 0;
      width: 100%;
    }
  }
</style>
