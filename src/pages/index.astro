---
import SiteLayout from "../layouts/SiteLayout.astro";
// import ResponsiveImage from "../components/ResponsiveImage.astro";
import { getYearGroups, type YearEntry } from "../lib/content-utils";
import { getCollection } from "astro:content";
import { clampExcerpt } from "../lib/formatting";

// const heroImage = {
//   src: "/images/meta/archive.jpg",
//   width: 1600,
//   height: 900,
//   alt: "Rows of catalog drawers and vinyl sleeves representing the Hot 100 archive",
//   format: "jpg" as const,
// };

const [yearGroups, metaEntries] = await Promise.all([getYearGroups(), getCollection("meta")]);

const createSeededRandom = (seed: number) => {
  let state = seed + 0x6d2b79f5;
  return () => {
    state = Math.imul(state ^ (state >>> 15), state | 1);
    state ^= state + Math.imul(state ^ (state >>> 7), state | 61);
    return ((state ^ (state >>> 14)) >>> 0) / 4294967296;
  };
};

const selectRandomYears = (groups: Record<number, YearEntry[]>, count: number, seed: number) => {
  const orderedYears = Object.keys(groups)
    .map((year) => Number(year))
    .sort((a, b) => a - b);

  const pool = orderedYears
    .map((year) => (groups[year] ?? [])[0])
    .filter((entry): entry is YearEntry => Boolean(entry));

  if (pool.length <= count) {
    return pool;
  }

  const random = createSeededRandom(seed);
  const available = [...pool];
  const selection: YearEntry[] = [];

  while (selection.length < count && available.length) {
    const index = Math.floor(random() * available.length);
    selection.push(available.splice(index, 1)[0]);
  }

  return selection;
};

const seed = Math.floor(Math.random() * 90000000) + 10000000;
const yearHighlights = selectRandomYears(yearGroups, 4, seed);

const sortedYears = Object.keys(yearGroups)
  .map((year) => Number(year))
  .sort((a, b) => b - a);

const latestYearEntry = sortedYears
  .map((year) => (yearGroups[year] ?? [])[0])
  .find((entry): entry is (typeof yearHighlights)[number] => Boolean(entry));

const aboutEntry =
  metaEntries.find((entry) => entry.slug === "about-the-archive") ?? metaEntries[0];
const toHref = (segment: string, slug: string) => `/${segment}/${slug}/`;
---

<SiteLayout
  description="Explore Cody's Billboard Hot 100 archive with year-by-year recaps and curated chart milestones."
  pageTitle="Home"
>
  <article class="hero">
    <div class="hero__content">
      <p class="hero__kicker">Billboard Hot 100</p>
      <h1>Every #1 Hit in the U.S. Ranked!</h1>
      <p class="hero__lead">
        Dive into the nightmare of a writing project I undertook in August 2021!
      </p>
      <div class="hero__actions">
        {
          latestYearEntry ? (
            <a class="hero__action" href={toHref("years", latestYearEntry.slug)}>
              Explore latest review
            </a>
          ) : null
        }
        <a class="hero__action hero__action--secondary" href="/years/">Browse all years</a>
      </div>
    </div>
    <!-- <figure class="hero__media">
      <ResponsiveImage
        image={heroImage}
        sizes="(min-width: 70rem) 28rem, 100vw"
        class="hero__image"
      />
    </figure> -->
  </article>

  <section class="section" aria-labelledby="year-section">
    <header class="section__header">
      <h2 class="section__title" id="year-section">Select a Random Year</h2>
      <p class="section__lead">Check out the thoughts & rankings for one of the following years.</p>
    </header>
    <div class="record-grid">
      {
        yearHighlights.map((entry) => (
          <a class="record-card record-card--link" href={toHref("years", entry.slug)}>
            <h2 class="record-card__title">{entry.data.title}</h2>
            <p class="record-card__excerpt">{clampExcerpt(entry.data.commentary_excerpt)}</p>
          </a>
        ))
      }
    </div>
  </section>

  {
    aboutEntry ? (
      <>
        <section class="sidebar-panel" aria-labelledby="sidebar-overview" slot="sidebar">
          <h2 class="sidebar-panel__title" id="sidebar-overview">
            How this archive works
          </h2>
          <p>{clampExcerpt(aboutEntry.data.commentary_excerpt)}</p>
          <ul class="sidebar-panel__list">
            <li class="sidebar-panel__item">
              <a href="/about/">Read the full overview</a>
            </li>
          </ul>
        </section>
        <section class="sidebar-panel" aria-labelledby="sidebar-updates" slot="sidebar">
          <h2 class="sidebar-panel__title" id="sidebar-updates">
            Recent yearly rankings
          </h2>
          <ul class="sidebar-panel__list">
            {sortedYears.slice(0, 8).map((year) => {
              const [entry] = yearGroups[year] ?? [];
              if (!entry) return null;
              return (
                <li class="sidebar-panel__item">
                  <a href={toHref("years", entry.slug)}>
                    {entry.data.title} Â· {year}
                  </a>
                </li>
              );
            })}
          </ul>
        </section>
      </>
    ) : null
  }
</SiteLayout>
