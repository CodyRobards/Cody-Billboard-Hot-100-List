---
import SiteLayout from "../../layouts/SiteLayout.astro";
import ResponsiveImage from "../../components/ResponsiveImage.astro";
import { getCollection } from "astro:content";
import NumberOnesList from "../../components/NumberOnesList.astro";
import OverallRankingList from "../../components/OverallRankingList.astro";
import { getYearGroups } from "../../lib/content-utils";

export async function getStaticPaths() {
  const entries = await getCollection("years");
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entryId: entry.id },
  }));
}

interface Props {
  entryId: string;
}

const { entryId } = Astro.props as Props;
const [entry] = await getCollection("years", ({ id }) => id === entryId);

if (!entry) {
  throw new Error(`Year entry not found for ${entryId}`);
}

const numberOnes = entry.data.numberOnes ?? [];
const overallRanking = entry.data.overallRanking ?? [];

const createSeededRandom = (seed: number) => {
  let state = seed + 0x6d2b79f5;
  return () => {
    state = Math.imul(state ^ (state >>> 15), state | 1);
    state ^= state + Math.imul(state ^ (state >>> 7), state | 61);
    return ((state ^ (state >>> 14)) >>> 0) / 4294967296;
  };
};

function shuffle<T>(items: readonly T[], seed: number) {
  const random = createSeededRandom(seed);
  const result = [...items];
  for (let i = result.length - 1; i > 0; i -= 1) {
    const j = Math.floor(random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}

const { Content } = await entry.render();
const yearGroups = await getYearGroups();
const decadeStart = Math.floor(entry.data.year / 10) * 10;
const decadeLabel = `${decadeStart}s`;

const allYearEntries = Object.values(yearGroups)
  .flat()
  .sort((a, b) => {
    if (a.data.year !== b.data.year) {
      return a.data.year - b.data.year;
    }
    return (a.data.ranking ?? 0) - (b.data.ranking ?? 0);
  });

const currentIndex = allYearEntries.findIndex((item) => item.slug === entry.slug);
const previousYear = currentIndex > 0 ? allYearEntries[currentIndex - 1] : null;
const nextYear =
  currentIndex >= 0 && currentIndex < allYearEntries.length - 1
    ? allYearEntries[currentIndex + 1]
    : null;

const random = createSeededRandom(entry.data.year * 2654435761);
const randomYearOptions = allYearEntries.filter((item) => item.slug !== entry.slug);
const randomYear = randomYearOptions.length
  ? randomYearOptions[Math.floor(random() * randomYearOptions.length)]
  : null;

const siblingYears = shuffle(
  allYearEntries.filter(
    (item) => Math.floor(item.data.year / 10) * 10 === decadeStart && item.slug !== entry.slug
  ),
  entry.data.year
).slice(0, 4);

const toHref = (segment: string, slug: string) => `/${segment}/${slug}/`;
const tags = entry.data.tags ?? [];
const summaryParagraphs = entry.data.yearSummary
  ? entry.data.yearSummary
      .split(/\n{2,}/)
      .map((paragraph) => paragraph.trim())
      .filter(Boolean)
  : [];
---

<SiteLayout pageTitle={entry.data.title} description={entry.data.commentary_excerpt}>
  <article class="article">
    <header class="article__header">
      <h1>{entry.data.year}</h1>
      {entry.data.title ? <p class="article__subhead">{entry.data.title}</p> : null}
      {
        entry.data.commentary_excerpt ? (
          <p class="article__lede">{entry.data.commentary_excerpt}</p>
        ) : null
      }
      <ResponsiveImage
        image={entry.data.cover_image}
        class="article__image"
        sizes="(min-width: 72rem) 32rem, 100vw"
      />
    </header>
    <div class="article__body">
      {entry.data.commentary ? <p>{entry.data.commentary}</p> : null}
      {summaryParagraphs.map((paragraph) => <p>{paragraph}</p>)}
      <Content />
      {
        numberOnes.length ? (
          <>
            <p>
              Revisit the {numberOnes.length} Hot 100 number ones that defined {entry.data.year},
              complete with weekly notes on the wildest chart runs.
            </p>
            <NumberOnesList
              heading="Weekly number ones"
              description={`All ${numberOnes.length} Hot 100 chart-toppers from ${entry.data.year}.`}
              items={numberOnes}
            />
          </>
        ) : null
      }
      {
        overallRanking.length ? (
          <>
            <p>
              When the year wrapped, these final rankings captured the songs that stuck with me
              most.
            </p>
            <OverallRankingList
              heading="Year-end favorites"
              description={`Personal ranking of ${overallRanking.length} number ones from ${entry.data.year}.`}
              items={overallRanking}
            />
          </>
        ) : null
      }
    </div>
    {
      tags.length ? (
        <div class="article__tags">
          {tags.map((tag) => (
            <span class="tag-chip">{tag}</span>
          ))}
        </div>
      ) : null
    }
    {
      (previousYear || nextYear || randomYear) && (
        <footer class="article__footer">
          <nav class="article-pagination" aria-label="Year navigation">
            <div class="article-pagination__item article-pagination__item--prev">
              {previousYear ? (
                <a class="article-pagination__link" href={toHref("years", previousYear.slug)}>
                  <span class="article-pagination__icon" aria-hidden="true">
                    ←
                  </span>
                  <span class="article-pagination__meta">
                    <span class="article-pagination__label">Previous</span>
                    <span class="article-pagination__title">
                      {previousYear.data.year} · {previousYear.data.title}
                    </span>
                  </span>
                </a>
              ) : null}
            </div>
            <div class="article-pagination__item article-pagination__item--random">
              {randomYear ? (
                <a class="article-pagination__button" href={toHref("years", randomYear.slug)}>
                  Surprise me
                </a>
              ) : null}
            </div>
            <div class="article-pagination__item article-pagination__item--next">
              {nextYear ? (
                <a class="article-pagination__link" href={toHref("years", nextYear.slug)}>
                  <span class="article-pagination__meta">
                    <span class="article-pagination__label">Next</span>
                    <span class="article-pagination__title">
                      {nextYear.data.year} · {nextYear.data.title}
                    </span>
                  </span>
                  <span class="article-pagination__icon" aria-hidden="true">
                    →
                  </span>
                </a>
              ) : null}
            </div>
          </nav>
        </footer>
      )
    }
  </article>

  {
    siblingYears.length ? (
      <section class="sidebar-panel" aria-labelledby="sidebar-sibling-years" slot="sidebar">
        <h2 class="sidebar-panel__title" id="sidebar-sibling-years">
          More from the {decadeLabel}
        </h2>
        <ul class="sidebar-panel__list">
          {siblingYears.map((item) => (
            <li class="sidebar-panel__item">
              <a href={toHref("years", item.slug)}>
                {item.data.year} · {item.data.title}
              </a>
            </li>
          ))}
        </ul>
      </section>
    ) : null
  }
</SiteLayout>
