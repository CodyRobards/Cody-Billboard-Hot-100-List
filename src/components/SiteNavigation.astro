---
import type { DecadeEntry, YearEntry } from "../lib/content-utils";
import { groupYearsByDecade } from "../lib/content-utils";

interface Props {
  years: Record<number, YearEntry[]>;
  decades: DecadeEntry[];
  currentPath: string;
}

const { years, decades, currentPath } = Astro.props as Props;

const ensureTrailingSlash = (href: string) => (href.endsWith("/") ? href : `${href}/`);

const isActive = (href: string) => {
  const normalizedHref = ensureTrailingSlash(href);
  return currentPath === normalizedHref || currentPath.startsWith(normalizedHref);
};

const decadeBuckets = groupYearsByDecade(years)
  .map((bucket) => {
    const items = bucket.years
      .map(({ year, entries }) => {
        const [primaryEntry] = entries ?? [];
        if (!primaryEntry) return null;
        const href = ensureTrailingSlash(`/years/${primaryEntry.slug}`);
        return {
          year,
          href,
          isActive: isActive(href),
        };
      })
      .filter(
        (
          item
        ): item is {
          year: number;
          href: string;
          isActive: boolean;
        } => Boolean(item)
      );

    const isCurrent = items.some((item) => item.isActive);

    return {
      decade: bucket.decade,
      items,
      isCurrent,
    };
  })
  .filter((bucket) => bucket.items.length > 0);

const decadeLinks = decades
  .map((entry) => {
    const href = ensureTrailingSlash(`/decades/${entry.slug}`);
    return {
      decade: entry.data.decade,
      label: `${entry.data.decade}s`,
      href,
      isActive: isActive(href),
    };
  })
  .sort((a, b) => a.decade - b.decade);
---

<nav class="site-nav" aria-label="Archive navigation">
  <div class="site-nav__intro">
    <a class="site-nav__home" href="/" aria-current={currentPath === "/" ? "page" : undefined}>
      Overview
    </a>
    <a
      class="site-nav__home"
      href="/search/"
      aria-current={isActive("/search/") ? "page" : undefined}
    >
      Search #1 hits
    </a>
    <a
      class="site-nav__home"
      href="/about/"
      aria-current={isActive("/about/") ? "page" : undefined}
    >
      About
    </a>
    <a
      class="site-nav__home"
      href="/rankings/"
      aria-current={isActive("/rankings/") ? "page" : undefined}
    >
      All rankings
    </a>
    <a
      class="site-nav__home"
      href="/rankings/top-220/"
      aria-current={isActive("/rankings/top-220/") ? "page" : undefined}
    >
      Top 220
    </a>
    <a
      class="site-nav__home"
      href="/rankings/bottom-60/"
      aria-current={isActive("/rankings/bottom-60/") ? "page" : undefined}
    >
      Bottom 60
    </a>
  </div>
  {
    decadeLinks.length ? (
      <div class="site-nav__section" aria-label="Decades">
        <h2 class="site-nav__heading">Decade overviews</h2>
        <ul class="site-nav__year-list">
          {decadeLinks.map((link) => (
            <li class={`site-nav__year-item ${link.isActive ? "is-current" : ""}`}>
              <a
                class="site-nav__year-link"
                href={link.href}
                aria-current={link.isActive ? "page" : undefined}
              >
                {link.label}
              </a>
            </li>
          ))}
        </ul>
      </div>
    ) : null
  }
  <div class="site-nav__section" aria-label="Years">
    <h2 class="site-nav__heading">Yearly rankings</h2>
    <ul class="site-nav__decade-list">
      {
        decadeBuckets.map((bucket) => {
          const headingId = `decade-${bucket.decade}`;
          return (
            <li class={`site-nav__decade ${bucket.isCurrent ? "is-current" : ""}`}>
              <h3 class="site-nav__decade-heading" id={headingId}>
                {bucket.decade}s
              </h3>
              <ul class="site-nav__year-list" aria-labelledby={headingId}>
                {bucket.items.map((item) => (
                  <li class={`site-nav__year-item ${item.isActive ? "is-current" : ""}`}>
                    <a
                      class="site-nav__year-link"
                      href={item.href}
                      aria-current={item.isActive ? "page" : undefined}
                    >
                      {item.year}
                    </a>
                  </li>
                ))}
              </ul>
            </li>
          );
        })
      }
    </ul>
  </div>
</nav>
